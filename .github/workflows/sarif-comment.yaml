name: "pr-sarif-commenter"
on:
  workflow_run:
    workflows: [ "pull-request-build" ]
    types: [ completed ]

jobs:
  comment:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: pr-number
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      - uses: actions/download-artifact@v4
        continue-on-error: true
        id: download
        with:
          name: pr-sarif
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      - uses: actions/checkout@v4
        if: steps.download.outcome == 'success'
        with:
          lfs: true
          submodules: recursive
          ref: refs/pull/${{ env.PR_NUM }}/merge
          fetch-depth: 0
      - name: Unzip and get the variables
        if: steps.download.outcome == 'success'
        run:
          ls -la
          unzip pr-sarif.zip
          unzip pr-number.zip
          pr=$(cat pr_number.txt);echo \"PR_NUM=$pr\" > $GITHUB_ENV
          ref=$(git rev-parse HEAD);echo \"GIT_HASH=$ref\" > $GITHUB_ENV
      - name: Post SARIF findings as comments in the pull request
        if: steps.download.outcome == 'success'
        uses: sett-and-hive/sarif-to-comment-action/composite@77c0eda9c886e978d3d914364ce8610a09b66907
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          branch: ${{ env.GIT_HASH }}
          pr-number: ${{ env.PR_NUM }}
          title: Lint report
          show-rule-details: false
          sarif-file: 'merge.sarif'
          simple: true
